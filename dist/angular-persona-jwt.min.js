/**
 * angular-persona-jwt - angularJs module to authenticate an app with Mozilla Persona
 * @version v 0.0.1
 * @link https://github.com/Charl---/angular-persona-jwt
 * @license MIT
 */
(function(angular) {'use strict';
function personaLogin(n){function o(){n.navigator.id.request()}return{restrict:"EA",scope:{onLogin:"=",onLogout:"="},transclude:!0,controller:["$scope","persona",function(n,e){this.login=o,n.$watch(function(){return e},function(){e.loggedUser&&n.onLogin&&n.onLogin()},!0)}],controllerAs:"persona",template:'<div ng-transclude ng-click="persona.login()"></div>'}}function personaLogout(n){function o(){n.navigator.id.logout()}return{restrict:"EA",transclude:!0,scope:{},controller:function(){this.logout=o},controllerAs:"persona",template:'<div ng-transclude ng-click="persona.logout()"></div>'}}function personaProvider(n,o){var e=n.$get(),r={baseUrl:"localhost",audience:e.location.href,tokenStorageKey:"angular-persona-jwt-token"},t={};return t.config=function(n){r=angular.extend(r,n),o.interceptors.push(["$q",function(n){return{request:function(n){var o=e.localStorage.getItem(r.tokenStorageKey);return o&&(n.headers.Authorization="Bearer "+o),n},responseError:function(o){return n.reject(o)}}}])},t.$get=function(n,o,t){var a=this,i=[],s=[],u=[];return this.addLoginListener=function(n){i.push(n)},this.addLogoutListener=function(n){s.push(n)},this.addLoginFailListener=function(n){u.push(n)},this.login=function(o){var t={assertion:o,audience:r.audience};n.post(r.baseUrl+"/login",t).success(function(n){a.loggedUser=n.user,e.localStorage.setItem(r.tokenStorageKey,n.token),angular.forEach(i,function(o){o(n.user)})}).error(function(){angular.forEach(u,function(n){n()})})},this.logout=function(){a.loggedUser=null,e.localStorage.removeItem(r.tokenStorageKey),angular.forEach(s,function(n){n()})},this.init=function(){var n=o.defer(),r=t[0].createElement("script");r.type="text/javascript",r.async=!0,r.src="https://login.persona.org/include.js";var i=t[0].getElementsByTagName("body")[0];return i.appendChild(r),r.onload=function(){e.navigator.id.watch({loggedInUser:a.loggedUser,onlogin:a.login,onlogout:a.logout}),n.resolve()},n.promise},this},t}angular.module("angular-persona-jwt",["angular-persona-jwt.services","angular-persona-jwt.directives"]),personaLogin.$inject=["$window","persona"],personaLogout.$inject=["$window","persona"],angular.module("angular-persona-jwt.directives",[]).directive("personaLogin",personaLogin).directive("personaLogout",personaLogout),personaProvider.$inject=["$windowProvider","$httpProvider"],angular.module("angular-persona-jwt.services",[]).provider("persona",personaProvider);
})(angular);
